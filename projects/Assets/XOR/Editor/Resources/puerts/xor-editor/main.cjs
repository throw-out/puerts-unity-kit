(()=>{"use strict";var e={3016:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerEvent=void 0,function(e){e.Ready="ready",e.StartProgream="startProgream",e.FileChanged="fileChanged"}(r||(t.WorkerEvent=r={}))},8101:e=>{e.exports=require("csharp")},9021:e=>{e.exports=require("fs")}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,r),o.exports}(()=>{const e=r(8101),t=r(3016),{Path:s}=e.System.IO;class i{constructor(e,t){this.ci=e,this.dev=t}start(r,i){if(this._worker&&this._worker.isAlive)throw new Error("invalid operation");const o=this._createWorker(i),n=new e.XOR.Services.Program;n.root=s.GetDirectoryName(r),n.Reset(),o.post(t.WorkerEvent.StartProgream,{project:r,program:n},!0),this._worker=o,this.ci.SetWorker.Invoke(o.source),this.ci.SetProgram.Invoke(n)}watch(t){try{let r=s.GetDirectoryName(t);this._watcher=this._createWatcher(r),e.XOR.Logger.Verbose&&e.XOR.Logger.Log(`<b>nodejs.FSWacther:</b> ${r}`)}catch(e){console.error(e)}}stop(){this._watcher&&this._watcher.close(),this._watcher=null,this._worker&&this._worker.stop(),this._worker=null,this.ci.SetWorker.Invoke(null),this.ci.SetProgram.Invoke(null)}bind(){let t=new e.XOR.Services.TSInterfaces;return t.Stop=()=>this.stop(),t.Start=(e,t)=>this.start(e,t),t.Watch=e=>this.watch(e),t.FileChanged=e=>this.change(e),t}change(e){this._changeEvents?this._changeEvents.add(e):(this._changeEvents=new Set,this._changeEvents.add(e),setTimeout((()=>{this.sendChangeEvent([...this._changeEvents]),this._changeEvents=null}),100))}sendChangeEvent(e){this._worker&&this._worker.isAlive&&this._worker.isInitialized?this._worker.post(t.WorkerEvent.FileChanged,e,!0):console.warn("worker is not alive or initializing:")}_createWorker(t){const r=new e.XOR.ThreadDebuggerOptions,s=new e.XOR.ThreadOptions;s.remote=!1,s.isEditor=!0,s.debugger=r;const i=new e.XOR.MixerLoader;this.dev&&i.AddLoader(this.dev);const o=new xor.ThreadWorker(i,s);return o.start(t),xor.globalListener.quit.add((()=>o.stop())),o}_createWatcher(e){const t=r(9021),i=[".ts",".tsx"],o=t.watch(e,{encoding:"utf8",persistent:!0,recursive:!0},((t,r)=>{"string"==typeof r&&i.includes(s.GetExtension(r))&&this.change(s.GetFullPath(s.Combine(e,r)))}));return xor.globalListener.quit.add((()=>o.close())),o}}function o(e,t){return new i(e,t).bind()}!function(){(global||globalThis||this).init=o}()})()})();